---
layout: post
title: "R-Tree ì¸ë±ìŠ¤ ì ìš©"
description: >
hide_last_modified: true
---

# R-Tree ì¸ë±ìŠ¤ ì ìš©

---

# ğŸš‚Â Motivation

RealMySQL 8.0ì„ ê³µë¶€í•˜ë˜ ë„ì¤‘, R-Treeë¥¼ ì‚¬ìš©í•˜ì—¬ ìœ„ê²½ë„ ë°ì´í„°ë¥¼ ì¸ë±ì‹±í•˜ë©´ ì„±ëŠ¥ì ìœ¼ë¡œ ì´ì ì„ ì–»ì„ ìˆ˜ ìˆë‹¤ê³  í•˜ì—¬ì„œ, ë§ˆì¹¨ ìœ„ê²½ë„ ë°ì´í„°ë¥¼ ì´ìš©í•˜ë˜ ê´‘ìƒì— ì ìš©í•œ í›„, **Before After**ë¥¼ ë¹„êµí•´ë´¤ë‹¤.

# â­Â What I Learned

## Before

### SQL

```sql
SELECT "m"."id"               AS "menuId",  
       "m"."name"             AS "menuName",  
       "m"."price"            AS "price",  
       "m"."count"            AS "count",  
       "s"."id"               AS "storeId",  
       "s"."name"             AS "storeName",  
       "m"."menu_picture_url" AS "menuPictureUrl",  
       "m"."selling_price"    AS "sellingPrice",  
       "m"."discount_rate"    AS "discountRate",  
       "mv"."view_count"      AS "viewCount"  
FROM "menus" "m"  
         LEFT JOIN "menu_views" "mv" ON "m"."id" = "mv"."menu_id"  
         LEFT JOIN "stores" "s" ON "m"."store_id" = "s"."id" AND "s"."deleted_date" IS NULL  
         LEFT JOIN "store_detail" "sd" ON "s"."id" = "sd"."store_id"  
WHERE 1 = 1 
			AND ST_DWithin(ST_Transform(ST_SetSRID(ST_MakePoint("sd"."lon", "sd"."lat"), 4326), 3857),  ST_Transform(ST_SetSRID(ST_MakePoint(127.0577492000820::numeric, 37.6203769557633::numeric), 4326), 3857), 3000) 
			AND "m"."selling_price" < 5000
		  AND "m"."deleted_date" IS NULL  
ORDER BY "mv"."view_count" DESC, "m"."id" ASC  
```

ê¸°ì¡´ì˜ ì¿¼ë¦¬ë¬¸ì—ì„œ ì£¼ì˜ê¹Šê²Œ ë´ì•¼í•  ë¶€ë¶„ì€ ì•„ë˜ ë¶€ë¶„ì´ë‹¤.

```sql
**ST_DWithin(ST_Transform(ST_SetSRID(ST_MakePoint("sd"."lon", "sd"."lat"), 4326), 3857),  ST_Transform(ST_SetSRID(ST_MakePoint(127.0577492000820::numeric, 37.6203769557633::numeric), 4326), 3857), 3000)** 
```

ìœ„ë„ì™€ ê²½ë„ê°’ì„ ê°€ì§€ê³  Pointë¥¼ ë§Œë“  í›„, Pointì™€ Pointì‚¬ì´ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•´ 3000mì´ë‚´ì˜ ê°€ê²Œë“¤ì„ ê°€ì ¸ì˜¤ëŠ” êµ¬ì¡°ì´ë‹¤.

ì´ êµ¬ì¡°ë¡œ ë¶€í•˜í…ŒìŠ¤íŠ¸(10ëª…ì˜ ì‚¬ìš©ìê°€ 10íšŒ)ë¥¼ ì§„í–‰í–ˆì„ ë•Œ, ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ê°€ ë„ì¶œëë‹¤.

![image.jpg](../../assets/img/Study/R-Tree ì¸ë±ìŠ¤ ì ìš©-11.jpg)

í‰ê· ì ìœ¼ë¡œ 142ms, ê°€ì¥ ëŠë¦°ì •ë„ì˜ ê°’ì€ 1408msë¡œ ì–´ì©Œë©´ ì‚¬ìš©ìê°€ ì²´ê°ì´ ë  ìˆ˜ ìˆì„ë§Œí¼ ì‹œê°„ì´ ê±¸ë¦° ê²ƒìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

(ì´ ê²°ê³¼ê°’ì€ ë¬¼ë¡  ì¿¼ë¦¬ë¬¸ë§Œ ì´ë¤„ì§€ì§„ ì•Šì•˜ë‹¤. Response ê°€ê³µì´ë‚˜ ì„œë²„ë‹¨ì—ì„œ ê°„ë‹¨í•œ ifë¬¸ì´ ìˆì—ˆìœ¼ë‚˜, ì¿¼ë¦¬ íŠœë‹ì„ ì§„í–‰í•œ ì´í›„ë„ ë˜‘ê°™ì€ ê³¼ì •ì„ ê±°ì¹˜ê¸°ì— ê²°ê³¼ ë„ì¶œì—ëŠ” ì˜ë¯¸ ì—†ë‹¤ê³  íŒë‹¨í–ˆë‹¤.)

## After

```javascript
@Column({
        type: 'geometry',
        spatialFeatureType: 'Point',
        srid: 3857,
        nullable: false,
        comment: 'ìœ„ë„ì™€ ê²½ë„ë¥¼ ê²°í•©í•œ ê³µê°„ ë°ì´í„°',
    })
@Index({ spatial: true })
point: Point;   
```

ìš°ì„ , entityì—ì„œ point ì¹¼ëŸ¼ì„ ì¶”ê°€í•œ í›„, R-Tree(ê³µê°„ ì¸ë±ìŠ¤)ë¥¼ ì ìš©í•´ì£¼ì—ˆë‹¤.

```sql
SELECT "m"."id"               AS "menuId",  
       "m"."name"             AS "menuName",  
       "m"."price"            AS "price",  
       "m"."count"            AS "count",  
       "s"."id"               AS "storeId",  
       "s"."name"             AS "storeName",  
       "m"."menu_picture_url" AS "menuPictureUrl",  
       "m"."selling_price"    AS "sellingPrice",  
       "m"."discount_rate"    AS "discountRate",  
       "mv"."view_count"      AS "viewCount"  
FROM "menus" "m"  
         LEFT JOIN "menu_views" "mv" ON "m"."id" = "mv"."menu_id"  
         LEFT JOIN "stores" "s" ON "m"."store_id" = "s"."id" AND "s"."deleted_date" IS NULL  
         LEFT JOIN "store_detail" "sd" ON "s"."id" = "sd"."store_id"  
WHERE 1 = 1 
			AND ST_DWithin("sd"."point", ST_SetSRID(ST_MakePoint(127.0577492000820, 37.6203769557633), 3857), 3000) 
			AND "m"."selling_price" < 5000
		  AND "m"."deleted_date" IS NULL
ORDER BY "mv"."view_count" DESC, "m"."id" ASC  
```

ë§ˆì°¬ê°€ì§€ë¡œ ì£¼ì˜ê¹Šê²Œ ë´ì•¼í•  ê³³ì€ ì•„ë˜ì™€ ê°™ë‹¤.

```sql
ST_DWithin("sd"."point", ST_SetSRID(ST_MakePoint(127.0577492000820, 37.6203769557633), 3857), 3000) 
```

ì´ë²ˆì—” entityì— ì €ì¥ë˜ì–´ ìˆëŠ” pointê°’ê³¼ ì‚¬ìš©ìì˜ ìœ„ì¹˜ê°’ì„ pointë¡œ ë³€í™˜í•´ 3000mì´ë‚´ì˜ ê°€ê²Œë¥¼ ì°¾ì•˜ë‹¤.

entityì— ì €ì¥ë  ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ pointê°’ì„ ì €ì¥í•˜ë‹ˆ ì¡°íšŒì‹œ ë” ë¹ ë¥¸ê²ƒë„ ë§ë‹¤ê³  ìƒê°í•œë‹¤. 
í•˜ì§€ë§Œ ê°€ê²Œê°€ ë“±ë¡ë˜ëŠ” ì‹œì ì— Pointê°’ì„ ê³„ì‚°í•´ì„œ ë„£ëŠ” ê²ƒì— ëŒ€í•œ ì˜¤ë²„í—¤ë“œì™€ ìˆ˜ë§ì€ ì‚¬ìš©ìë“¤ì´ ë‚´ ì£¼ë³€ì˜ ê°€ê²Œë¥¼ ì°¾ëŠ” ì¡°íšŒì˜ ì˜¤ë²„í—¤ë“œë¥¼ ë¹„êµí•˜ëŠ” ê²ƒì€ í˜¸ì¶œ íšŸìˆ˜ê°€ ì°¨ì´ë‚˜ê¸°ì— ë¬´ì˜ë¯¸í•˜ë‹¤ê³  ìƒê°í–ˆë‹¤.

ì´ êµ¬ì¡°ë¡œ ë¶€í•˜í…ŒìŠ¤íŠ¸(10ëª…ì˜ ì‚¬ìš©ìê°€ 10íšŒ)ë¥¼ ì§„í–‰í–ˆì„ ë•Œ, ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ê°€ ë„ì¶œëë‹¤.

![image.jpg](../../assets/img/Study/R-Tree ì¸ë±ìŠ¤ ì ìš©-26.jpg)

ì¤‘ê°„ê°’ì€ 100.8msë¡œ ì•½ 40msë¥¼, ê°€ì¥ ëŠë¦°ì •ë„ì˜ ê°’ì€ 1085.9msë¡œ 300ms ë„˜ê²Œ ì„±ëŠ¥ì„ ê°œì„ í•  ìˆ˜ ìˆì—ˆë‹¤. 

ì‹¤í–‰ ê³„íšì„ í™•ì¸í•˜ì˜€ì„ ë•Œ, Pointì— ëŒ€í•´ì„œ Index Scanì„ ì‚¬ìš©í•œ ê²ƒë„ í™•ì¸í•˜ì˜€ë‹¤.

![image.jpg](../../assets/img/Study/R-Tree ì¸ë±ìŠ¤ ì ìš©-29.jpg)

# ğŸ’­Â Impression
1. R-Tree ì¸ë±ìŠ¤ë¥¼ ì ìš©í•´ë³¸ê²ƒì€ ì²˜ìŒì´ì—¬ì„œ ìƒ‰ë‹¤ë¥¸ ê²½í—˜ì„ í–ˆë‹¤ê³  ëŠê¼ˆë‹¤.
2. ì‹¤ì œë¡œ ì„±ëŠ¥ìƒì˜ ë³€í™”ê°€ í¬ê²Œ ì—†ìœ¼ë©´ ì–´ë–¡í•˜ì§€? ë¼ëŠ” ê³ ë¯¼ë„ í–ˆì—ˆëŠ”ë° ìœ ì˜ë¯¸í•œ ê²°ê³¼ê°€ ë‚˜ì™€ì„œ ê¸°ë¶„ì´ ì¢‹ë‹¤.
3. ê³µê°„ ë°ì´í„°ë¥¼ í™œìš©í•  ë•Œ, ìœ„ë„ì™€ ê²½ë„ê°’ë§Œì„ DBì— ì €ì¥í•˜ëŠ” ê²ƒë³´ë‹¨, ìœ„ë„ì™€ ê²½ë„ë¥¼ ì´ìš©í•œ ê³µê°„ë°ì´í„°ê°’ë„ ì¶”ê°€í•´ì„œ ë„£ì–´ë‘ëŠ” ê²ƒë„ ì¢‹ì•„ë³´ì¸ë‹¤. ìƒí™©ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê±° ê°™ë‹¤.
